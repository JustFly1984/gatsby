import prettier from "prettier"
// eslint-disable-next-line @typescript-eslint/naming-convention
import Joi from "@hapi/joi"
// @ts-ignore
// eslint-disable-next-line @typescript-eslint/naming-convention
import Handlebars from "handlebars"
import fs from "fs-extra"
// eslint-disable-next-line @typescript-eslint/naming-convention
import _ from "lodash"
// @ts-ignore
import toc from "markdown-toc"
import prettierConfig from "../../.prettierrc.js"

import { pluginOptionsSchema } from "./src/steps/declare-plugin-options-schema.mjs"

/**
 * This script generates ./docs/plugin-options.md from the plugin options schema.
 * ./docs/plugin-options.md should never be edited directly since it's auto-generated. Update ./src/steps/declare-plugin-options-schema.ts instead
 */

// :( poor children
const excludeParentsChildren = [`RootQuery`]
/**
 * Takes the keys from a Joi schema and recursively
 * turns the nested keys into structured markdown documentation
 *
 * @param {{
 *  keys: Joi.SchemaMap
 *  mdString?: string | undefined
 *  level?: number | undefined
 *  parent?: string | null | undefined
 *  parentMetas?: Array<Joi.Meta> | undefined
 * }} props
 * @returns {string}
 */
function joiKeysToMD({
  keys,
  mdString = ``,
  level = 1,
  parent = null,
  parentMetas = [],
}) {
  if (
    !keys ||
    (parentMetas.length && parentMetas.find((meta) => meta.portableOptions))
  ) {
    return mdString
  }

  Object.entries(keys).forEach(([key, value]) => {
    // @ts-ignore
    const isRequired = value.flags && value.flags.presence === `required`

    const title = `${parent ? `${parent}.` : ``}${key}${
      isRequired ? ` (**required**)` : ``
    }`

    mdString += `${`#`.repeat(level + 1)} ${title}`

    // @ts-ignore
    if (value.description) {
      mdString += `\n\n`
      // @ts-ignore
      const description = value.description.trim()
      mdString += description.endsWith(`.`) ? description : `${description}.`
    }

    // @ts-ignore
    if (value.type) {
      const { trueType } =
        // @ts-ignore
        (value.meta && value.meta.find((meta) => `trueType` in meta)) || {}

      mdString += `\n\n`
      // @ts-ignore
      mdString += `**Field type**: \`${(trueType || value.type)
        .split(`|`)
        .map((typename) => _.startCase(typename))
        .join(` | `)}\``
    }

    if (
      // @ts-ignore
      (value.flags && `default` in value.flags) ||
      // @ts-ignore
      (value.meta && value.meta.find((meta) => `default` in meta))
    ) {
      const defaultValue =
        // @ts-ignore
        ((value.meta && value.meta.find((meta) => `default` in meta)) || {}) // @ts-ignore
          .default || value.flags.default

      let printedValue

      if (typeof defaultValue === `string`) {
        printedValue = defaultValue
      } else if (Array.isArray(defaultValue)) {
        printedValue = `[${defaultValue.join(`, `)}]`
      } else if (
        [`boolean`, `function`, `number`].includes(typeof defaultValue)
      ) {
        printedValue = defaultValue.toString()
      } else if (defaultValue === null) {
        printedValue = `null`
      }

      if (typeof printedValue === `string`) {
        mdString += `\n\n`
        mdString += `**Default value**: ${
          printedValue.includes(`\n`)
            ? `\n\`\`\`js\n${printedValue}\n\`\`\``
            : `\`${printedValue}\``
        }`
      }
    }

    // @ts-ignore
    if (value.meta) {
      // @ts-ignore
      const examples = value.meta.filter((meta) => `example` in meta)
      examples.forEach(({ example }) => {
        mdString += `\n\n\`\`\`js\n` + example + `\n\`\`\`\n`
      })
    }

    mdString += `\n\n`

    const excludeChildren = excludeParentsChildren.includes(key)

    // @ts-ignore
    if (!excludeChildren && value.children) {
      mdString = joiKeysToMD({
        // @ts-ignore
        keys: value.children,
        mdString,
        level: level + 1,
        parent: title,
        // @ts-ignore
        parentMetas: value.meta,
      })
    }

    // @ts-ignore
    if (!excludeChildren && value.items && value.items.length) {
      // @ts-ignore
      value.items.forEach((item) => {
        if (item.children) {
          mdString = joiKeysToMD({
            keys: item.children,
            mdString,
            level: level + 1,
            parent: title + `[]`,
            // @ts-ignore
            parentMetas: value.meta,
          })
        }
      })
    }
  })

  return mdString
}

/**
 * Converts the Joi schema description into markdown
 * and writes it to the filesystem
 *
 * @param {object} description
 * @returns {Promise<string>}
 */
async function generateMdStringFromSchemaDescription(description) {
  const template = Handlebars.compile(`# Plugin Options

[comment]: # (This file is automatically generated. Do not edit it directly. Instead, edit the Joi schema in ./plugin/src/steps/declare-plugin-options-schema.mjs)
{{{tableOfContents}}}
{{{docs}}}

# Up Next :point_right:

- :boat: [Migrating from other WP source plugins](./migrating-from-other-wp-source-plugins.md)
- :house: [Hosting WordPress](./hosting.md)
- :athletic_shoe: [Themes, Starters, and Examples](./themes-starters-examples.md)
- :medal_sports: [Usage with popular WPGraphQL extensions](./usage-with-popular-wp-graphql-extensions.md)
- :hammer_and_wrench: [Debugging and troubleshooting](./debugging-and-troubleshooting.md)
- :national_park: [Community and Support](./community-and-support.md)
- :point_left: [Back to README.md](../README.md)`)

  const docs = joiKeysToMD({
    keys: description.children,
  })
  const tableOfContents = toc(docs).content

  const mdContents = template({
    tableOfContents,
    docs,
  })

  const mdStringFormatted = prettier.format(mdContents, {
    parser: `markdown`,
    ...prettierConfig,
  })

  return mdStringFormatted
}

export async function getPluginOptionsMdString() {
  const description = (await pluginOptionsSchema({ Joi })).describe()
  const mdString = await generateMdStringFromSchemaDescription(description)
  return mdString
}

async function writePluginOptionsMdFile() {
  console.info(`writing out plugin options schema docs to plugin-options.md`)
  const mdString = await getPluginOptionsMdString()
  await fs.writeFile(`./docs/plugin-options.md`, mdString)
}

if (process.env.NODE_ENV !== `test`) {
  writePluginOptionsMdFile()
}
